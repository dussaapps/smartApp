<html>

<head>
    <title>Smart Text</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js"></script>
    <script type="text/javascript">
        function MyViewModel() {
            var Self = this;

            Self.errmsg = ko.observable('');
            Self.loginname = ko.observable('');
            Self.password = ko.observable('');
            Self.showLogin = ko.observable(true);

            Self.logout = function () {
                document.cookie.split(";").forEach(function (c) { document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); });
                Self.showLogin(true);
            }

            Self.loginnow = function () {


                var reqData = {
                    username: Self.loginname(),
                    passcode: Self.password()
                }
                Self.loginname('');
                Self.password('');
                Self.errmsg('');
                $.post("/login", reqData, function (result) {
                    if (result.isSuccess) {
                        Self.showLogin(false);
                    }
                    else {
                        Self.errmsg('Invalid login details');
                    }
                });

            }

            Self.msgs = ko.observableArray([]);
            Self.key = ko.observable('');
            Self.msg = ko.observable('');

            Self.showLoginScreen = function () {
                Self.showLogin(true);
                Self.loginname('');
                Self.password('');
                Self.errmsg('');
            }

            getmsgs = function (keyFromOthers) {
                if (Self.key() || keyFromOthers) {
                    var key = Self.key() || keyFromOthers;
                    Self.key('')
                    $.ajax({
                        url: "/getmsgs?code=" + key, success: function (result) {


                            if (result.sessionExpired) {
                                Self.showLoginScreen();
                                Self.errmsg('Session Expired');
                                return;
                            }
                            Self.msgs(result.msgs);
                            setTimeout(() => {
                                Self.msgs.removeAll();
                            }, 10000)
                            // console.log(Self.msgs())
                            //$("#divContent").html(result.msgs);
                        }
                    });
                }
            };

            postmsgs = function () {
                if (Self.key()) {
                    var key = Self.key();
                    Self.key('');
                    var reqData = {
                        msg: Self.msg(),
                        code: key
                    }
                    $.post("/msgs", reqData, function (result) {
                        if (result.sessionExpired) {
                            Self.showLoginScreen();
                            Self.errmsg('Session Expired');
                        }
                        Self.msg('');
                        getmsgs(key);
                    });
                }
            }



        };
        $(document).ready(function () {

            ko.applyBindings(new MyViewModel());
            //getmsgs();
        }

        )
    </script>
    <style lang="text/css">
        .alignright {
            text-align: right;
        }
        .bg {
background-color: grey;
        }
    </style>
</head>

<body style="vertical-align: center" class="bg">
    <div class="container">
        <h2>Smart Text</h2>
        <div data-bind="visible:showLogin()" class="panel panel-default">
            <div class="panel-body">
                <p style="color: red" data-bind="html:errmsg"></p>

                <div class="form-group">
                    <label for="usr">username:</label>
                    <input class="form-control" placeholder="Enter username" data-bind="value:loginname" id="usr">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" class="form-control" placeholder="Enter password" data-bind="value:password" />
                </div>
                <button name="send" class="btn btn-default" data-bind="click:loginnow">Login</button>
            </div>
        </div>
        <div data-bind="visible:!showLogin()" class="panel panel-default">
            <div class="panel-body">
                <span>
                <h4>Welcome</h4>
                <button name="logout" class="btn btn-default" data-bind="click:logout">Logout</button>
                </span>
                <div data-bind="foreach: msgs">

                    <div data-bind="css:fromme? 'alignright':''">
                        <h4 data-bind="text: msg"></h4>
                        <p>Time: <span data-bind="text: createdDate"></span></p>
                    </div>
                </div>
                <div class="panel-body">
                     <div class="form-group">
                    <!-- <label>Key:</label> -->
                    <input class="form-control" placeholder="key" name="key" data-bind="value:key" />                    
                     </div>
                <div class="form-group">
                    <!-- <label>Message:</label>  -->
                    <input name="msg" class="form-control input-lg" placeholder="message" data-bind="value:msg" />                    
                </div>
                <button class="btn btn-default" name="send" data-bind="click:getmsgs">View</button>
                    <button class="btn btn-default" name="send" data-bind="click:postmsgs">Send</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>